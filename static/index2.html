<html>
  <head>
    <link rel="stylesheet" href="tacit.min.css"/>
    <style>
      .js-action {
        background: #367ac3;
        color: #fff;
        border-radius: 3.6px;
        cursor: pointer;
        display: inline;
        margin-bottom: 18px;
        margin-right: 7.2px;
        padding: 6.525px 23.4px;
        text-align: center;
      }

      .js-action:hover,button[type="submit"]:hover {
          background: #255587;
          color: #bfbfbf
      }
      #preview {
        padding: 5px;
        background-color: #333;
      }
      #preview span {
        display: block;
        width: 4px;
        height: 4px;
        float: left;
      }
      #stored > li {
        cursor: pointer;
      }
      #stored > li > span {
        display: block;
        width: 4px;
        height: 4px;
        float: left;
      }
    </style>
  </head>
  <body>
    <div id="preview"></div>
    <form action="js" method="get">
      <input id="funcName" type="text" name="name" placeholder="name" />
      <span class="js-action" onClick="loadPreview()">Preview</span>
      <span class="js-action" onClick="save()">Save</span>
      <br />
      <textarea id="function" name="function" cols="80" rows="7">
        {
          pi2: Math.PI * 2,
          f: function(x, t) { 
          return [(Math.sin(t * this.pi2 + (x * this.pi2)) + 1.0) / 2,  (Math.cos(t * 3.14 + (x * this.pi2)) + 1.0) / 2.0, t];
          }
        }
      </textarea>
      <br />
      <input type="submit" value="Dance for me!" />
    </form>
    <ul id="stored"></ul>

    <script type="text/javascript">
      function componentToHex(c) {
          var hex = c.toString(16);
          return hex.length == 1 ? "0" + hex : hex;
      }

      function rgbToHex(r, g, b) {
          return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
      }
      function loadPreview(){
        eval('func = ' + document.getElementById('function').value);
      }

      
      var allFunctions = [];
      var func = {f: function(t,x){ return [t, 0, 0.5];}}
      var storedPreviewInterval = null;

      function save() {
        var name = document.getElementById('funcName').value;
        var functionStr = document.getElementById('function').value;
        var existing = findStoredFunc(name);
        if (existing == null) {
          allFunctions.push({name: name, functionStr: functionStr});
        } else {
          existing.functionStr = functionStr;
        }
        localStorage.setItem('functions', JSON.stringify(allFunctions));
        renderList();
      }

      function findStoredFunc(name) {
        var found = null;
        allFunctions.forEach(function(f){
          if (f.name === name) {
            found = f;
          }
        });
        return found;
      };

      function loadFunc(name) {
        var text = '';
        allFunctions.forEach(function(f){
          if (f.name === name) {
            text = f.functionStr;
          }
        });
        document.getElementById('function').value = text;
        document.getElementById('funcName').value = name;
      }

      var pTime = 0;
      function renderList() {
        if (storedPreviewInterval != null) {
          clearInterval(storedPreviewInterval);
        }
        var storedFunctionsNode = document.getElementById('stored');
        while (storedFunctionsNode.firstChild) {
            storedFunctionsNode.removeChild(storedFunctionsNode.firstChild);
        }
        var previewResolution = 100;

        allFunctions.forEach(function(f){
          eval('f.evaled = ' + f.functionStr);
          
          var li = document.createElement("li");
          var title = document.createTextNode(f.name);
          li.appendChild(title);
          li.setAttribute('onclick', 'loadFunc("' + f.name + '")');
          for (var i = 0; i < previewResolution; i++) {
            var span = document.createElement("span");
            span.setAttribute('style', 'background-color: red');
            li.appendChild(span);    
          }
          storedFunctionsNode.appendChild(li);
        });
        storedPreviewInterval = setInterval(function(){
          pTime += 0.04;
          if (pTime > 1.0) {
            pTime = 0.0;
          }

          [].slice.call(storedFunctionsNode.children).forEach(function(li){
            var funcName = li.firstChild.textContent;
            var storedFunc = findStoredFunc(funcName);

            for (var i = 0; i < previewResolution; i++) {
              var rgb = storedFunc.evaled.f(pTime, i/previewResolution.toFixed(1));
              var rgb_str = rgbToHex(Math.round(rgb[0] * 255), Math.round(rgb[1] * 255), Math.round(rgb[2] * 255));
              li.children[i].setAttribute('style', 'background-color: ' + rgb_str);
            }
          }); 
        }, 40);
      }

      function init() {
        var storedFunctionsStr = localStorage.getItem('functions');
        if (storedFunctionsStr == null) {
          storedFunctionsStr = '[]';
        }
        allFunctions = JSON.parse(storedFunctionsStr);
        renderList();

        var preview = document.getElementById('preview');
        for (var i = 0; i < 240; i++) {
          var span = document.createElement("span");
          span.setAttribute('style', 'background-color: red');
          preview.appendChild(span);    
        }
        var time = 0;
        setInterval(function(){
          time += 0.04;
          if (time > 1.0) {
            time = 0.0;
          }
          for (var i = 0; i < 240; i++) {
            var rgb = func.f(time, i/240.0);
            var rgb_str = rgbToHex(Math.round(rgb[0] * 255), Math.round(rgb[1] * 255), Math.round(rgb[2] * 255));
            preview.children[i].setAttribute('style', 'background-color: ' + rgb_str);
          }
          
        }, 40); 
      }
      init();
    </script>

  </body>
</html>
