!!!
%head
  %title= "Disko Player #{App::VERSION}"

  %link{rel: "stylesheet", href: "/css/bootstrap.min.css"}
  %script{src: "//code.jquery.com/jquery-1.12.0.min.js"}
  %script{src: "//cdn.opalrb.org/opal/0.9.2/opal.min.js"}
  %script{src: "//cdn.opalrb.org/opal/0.9.2/opal-parser.min.js"}

  :sass
    body
      background-color: #555
      padding: 15px

    .row
      margin-bottom: 15px

    textarea, input[type=text]
      font-family: monospace

    #name
      margin-bottom: 15px

    #patterns .col-sm-3
      margin-bottom: 15px

    button
      min-height: 5em

    .pattern
      position: relative
      padding: 0
      min-height: 5em

      canvas
        position: absolute
        left: 0
        top: 0

%body

  .row
    .col-sm-10
      #current.btn.btn-default.btn-block.pattern
        %canvas

    .col-sm-2
      %button#edit.btn.btn-block.btn-primary Edit

  .row
    #editor{style: 'display:none;'}
      .col-sm-8
        %textarea#render_rb.form-control{name: 'name', cols: 80, rows: 7}
        %textarea#render_js.form-control{name: 'name', cols: 80, rows: 7, disabled: true}
      .col-sm-4
        %input#name.form-control{type: 'text', name: 'name', placeholder: 'Name'}
        .row
          .col-sm-6
            %button.btn.btn-block.btn-success#preview Preview
          .col-sm-6
            %button.btn.btn-block.btn-primary#store Save

  .row
    #patterns

  :coffeescript
    Opal.load('opal-parser')

    mode = 'play'

    toggleMode = () ->
      if mode == 'play'
        mode = 'edit'
        $('#editor').slideDown()
        $(this).removeClass 'btn-primary'
        $(this).addClass 'btn-danger'
      else
        if mode == 'edit'
          mode = 'play'
          $('#editor').slideUp()
          $(this).removeClass 'btn-danger'
          $(this).addClass 'btn-primary'

    preview = () ->
      compiled = Opal.compile $('#render_rb').val()
      $('#render_js').val(compiled)
      eval compiled + "\n var evaled = Opal.Renderer.$new();"
      $('#current').data 'evaled', evaled
      $('#current').data 'render_js', compiled
      $('#current').data 'render_rb', $('#render_rb').val()


    select = () ->
      name = $(this).data 'name'
      evaled = $(this).data 'evaled'
      render_js = $(this).data 'render_js'
      render_rb = $(this).data 'render_rb'

      $('#current').data 'name', name
      $('#current').data 'evaled', evaled
      $('#current').data 'render_js', render_js
      $('#current').data 'render_rb', render_rb

      if mode == 'play'
        $.ajax '/play/' + name, method: 'PUT'

      if mode == 'edit'
        $('#render_js').val(render_js)
        $('#render_rb').val(render_rb)
        $('#name').val(name)

    refreshPatterns = () ->
      $('#patterns').empty()

      $.get '/patterns', (data) ->
        $.each data, (index, value) ->
          eval 'var evaled = ' + value.render_js
          col = $('<div class="col-sm-3"></div>')
          button = $('<button class="btn btn-block pattern"><canvas/></button>')
          button.data 'name', value.name
          button.data 'evaled', evaled
          button.data 'render_js', value.render_js
          button.data 'render_rb', value.render_rb
          button.on 'click', select
          col.append(button)
          $('#patterns').append(col)

    store = () ->
      $.post '/store', {
        'name': $('#name').val(),
        'render_rb': $('#current').data('render_rb'),
        'render_js': $('#current').data('render_js') },
        refreshPatterns

    $ ->
      refreshPatterns()

      $('#preview').on 'click', preview
      $('#store').on 'click', store
      $('#edit').on 'click', toggleMode

      time = 0.0

      render = () ->
        time += 0.04
        if time > 1.0 then time = 0.0

        $('.pattern').each (_) ->
          canvas = $(this).find('canvas').get(0)
          canvas.style.width ='100%'
          canvas.style.height='100%'
          canvas.width  = canvas.offsetWidth
          canvas.height = canvas.offsetHeight

          context = canvas.getContext('2d')
          evaled = $(this).data 'evaled'

          if evaled?
            for i in [0..canvas.width] by 2
              if evaled.f
                color = evaled.f(time, i/canvas.width)
              else
                color = evaled.$render(time, i/canvas.width)
              style = 'rgb(' + (color[0] * 255.0).toFixed() + ',' + (color[1] * 255.0).toFixed() + ',' + (color[2] * 255.0).toFixed() + ')'
              context.fillStyle = style
              context.fillRect i, 0, 2, canvas.height

      setInterval render, 40
